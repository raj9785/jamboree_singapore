<?phpclass SchedulesController extends ScheduleAppController {    /**     * Controller name     *     * @var string     */    var $name = 'Schedules';    public $helpers = array('Html', 'Form', 'Session', 'Time', 'Text');    public $components = array('Auth', 'Session', 'Email', 'Cookie', 'Search.Prg', 'RequestHandler');    public $presetVars = array(array('field' => 'email', 'type' => 'value'), array('field' => 'firstname', 'type' => 'value'), array('field' => 'username', 'type' => 'value'), array('field' => 'mobile', 'type' => 'value'), array('field' => 'user_role_id', 'type' => 'value'), array('field' => 'status', 'type' => 'value'));    //public $presetVars = 	true;    public function beforeFilter() {        parent::beforeFilter();        $this->set('model', $this->modelClass);        $this->set('tab_open', 'schedules');        $this->loadModel("Course");        $cat_list = $this->Course->find("list", array(            'conditions' => array(                'is_active' => 1            ), //'order' => array("name" => "ASC"),                )        );        $this->set("cat_list", $cat_list);    }    public function index() {        $conditions = array();        $conditions = array();        $limitValue = $limit = 25;        $page = ((isset($this->params->named['page']) && $this->params->named['page'] != "") ? $this->params->named['page'] : 0);        $this->set('limitValue', $limitValue);        $this->set('limit', $limit);        $this->set('page', $page);        if ($this->request->is('get') && !isset($this->request->data['recordsPerPage'])) {            if (!empty($this->request->query)) {                if (isset($this->request->query['course_id']) && $this->request->query['course_id'] != "") {                    array_push($conditions, array('Schedule.course_id' => $this->request->query['course_id']));                    $this->set("course_id", $this->request->query['course_id']);                }                if (isset($this->request->query['is_active']) && $this->request->query['is_active'] != "") {                    array_push($conditions, array('Schedule.is_active' => $this->request->query['is_active']));                    $this->set("is_active", $this->request->query['is_active']);                }                if (isset($this->request->query['title']) && $this->request->query['title'] != "") {                    array_push($conditions, array('Schedule.title LIKE' => "%" . $this->request->query['title'] . "%"));                    $this->set("title", $this->request->query['title']);                }                if (@$this->request->query['from_date'] and @ $this->request->query['to_date']) {                    array_push($conditions, array('(DATE_FORMAT(Schedule.created_on, "%Y-%m-%d") >= ? AND DATE_FORMAT(Schedule.created_on, "%Y-%m-%d") <= ?)' => array($this->request->query['from_date'], $this->request->query['to_date'])));                } else                if (@$this->request->query['from_date']) {                    array_push($conditions, array('DATE_FORMAT(Schedule.created_on, "%Y-%m-%d") >= ' => $this->request->query['from_date']));                } else                if (@$this->request->query['to_date']) {                    array_push($conditions, array('DATE_FORMAT(Schedule.created_on, "%Y-%m-%d") <= ' => $this->request->query['to_date']));                }                $this->set("from_date", @$this->request->query['from_date']);                $this->set("to_date", @$this->request->query['to_date']);            }        }        $this->paginate = array(            'conditions' => $conditions,            'limit' => 25,            'order' => array(                'Schedule.created_on' => 'DESC'            )        );        $this->set('records', $this->paginate('Schedule'));        $this->set('title_for_layout', 'Batch Schedules');    }    public function add() {        if ($this->request->is('post')) {            $this->request->data['Schedule']['created_on'] = date("Y-m-d H:i:s");            $this->request->data['Schedule']['is_active'] = 1;            $check_duplicate = $this->Schedule->find('count', array(                'conditions' => array(                    'Schedule.course_id' => $this->request->data['Schedule']['course_id'],                    'Schedule.schedule_type' => $this->request->data['Schedule']['schedule_type'],                    'Schedule.duration' => $this->request->data['Schedule']['duration'],                    'Schedule.timings' => $this->request->data['Schedule']['timings'],                    'Schedule.days' => $this->request->data['Schedule']['days'],                    'Schedule.start_date' => $this->request->data['Schedule']['start_date'],                )            ));            if ($check_duplicate == 0) {                if ($this->Schedule->save($this->request->data)) {                    $new_id = $this->{$this->modelClass}->id;                    $json_data = json_encode($this->request->data);                    $text_action = "received";                    $this->global_logs("schedules", $new_id, 0, $text_action, $json_data);                    $this->Session->setFlash(__('Schedule added successfully'), 'success');                    $this->redirect(array('plugin' => 'schedule', 'controller' => 'schedules', 'action' => 'index'));                }            } else {                $this->Session->setFlash('Schedule already exists', 'error');            }        }        $this->set('title_for_layout', 'Add New Batch Schedule');    }    public function edit() {        $user_id = $this->params->query['id'];        $conditions = array(            "Schedule.id" => $user_id,        );        if (!$user_id || $user_id == NULL) {            $this->Session->setFlash('Invalid request to edit schedule', 'error');            $this->redirect(array('plugin' => 'schedule', 'controller' => 'schedules', 'action' => 'index'));        } else {// check that user exists or not            $check_user_exists = $this->Schedule->Find('count', array('conditions' => $conditions, 'recursive' => -1));            if ($check_user_exists == 0) {                $this->Session->setFlash('Schedule does not exists', 'error');                $this->redirect(array('plugin' => 'schedule', 'controller' => 'schedules', 'action' => 'index'));            }        }        $users_data = $this->Schedule->find('first', array('conditions' => $conditions));        $this->set('users_data', $users_data);        if ($this->request->is('post') || $this->request->is('put')) {            $check_duplicate = $this->Schedule->find('count', array(                'conditions' => array(                    'Schedule.course_id' => $this->request->data['Schedule']['course_id'],                    'Schedule.schedule_type' => $this->request->data['Schedule']['schedule_type'],                    'Schedule.duration' => $this->request->data['Schedule']['duration'],                    'Schedule.timings' => $this->request->data['Schedule']['timings'],                    'Schedule.days' => $this->request->data['Schedule']['days'],                    'Schedule.start_date' => $this->request->data['Schedule']['start_date'],                    'Schedule.id !=' => $user_id                )            ));            if ($check_duplicate == 0) {                if ($this->Schedule->save($this->request->data)) {                    $json_data = json_encode($this->request->data);                    $text_action = "updated";                    $this->global_logs("schedules", $user_id, 1, $text_action, $json_data);                    $this->Session->setFlash(__('Schedule updated successfully'), 'success');                    $this->redirect(array('plugin' => 'schedule', 'controller' => 'schedules', 'action' => 'index'));                } else {                    $this->Session->setFlash('Schedule couldn\'t be updated, try again later', 'error');                }            } else {                $this->Session->setFlash('Schedule already exists', 'error');            }        } else {            $this->data = $users_data;        }        $this->set('title_for_layout', 'Update Schedule');    }    public function status_ajax() {        if ($this->request->is('Ajax')) {            if ($this->data['id'] != null) {                $all_data = $this->{$this->modelClass}->findById($this->data['id']);                if ($all_data[$this->modelClass]['is_active'] == 1) {                    $new_value = 0;                    $data['is_active'] = 0;                    $status = 3;                    $text_action = " inactivated";                } else {                    $new_value = 1;                    $data['is_active'] = 1;                    $status = 2;                    $text_action = " activated";                }                $this->{$this->modelClass}->id = $this->data['id'];                $this->{$this->modelClass}->save($data, false);                $json_data = json_encode($data);                $this->global_logs("schedules", $this->data['id'], $status, $text_action, $json_data);                echo 1;            }        }        exit;    }    public function aprove_ajax() {        if ($this->request->is('Ajax')) {            if ($this->data['id'] != null) {                $all_data = $this->{$this->modelClass}->findById($this->data['id']);                $new_value = 1;                $data['verified'] = 1;                $status = 4;                $text_action = " approved";                $this->{$this->modelClass}->id = $this->data['id'];                $this->{$this->modelClass}->save($data, false);                $json_data = json_encode($data);                $this->global_logs("schedules", $this->data['id'], $status, $text_action, $json_data);                echo $new_value;            }        }        exit;    }    function schedule_details($id) {        $this->loadModel('Log');        $dtls = $this->Log->find('all', array('fields' => array('id', 'action_type', 'table_id', 'text_action', 'created', 'action_taken_by_name'), 'conditions' => array('table_name' => 'schedules', 'table_id' => $id), 'order' => array(                'Log.id' => 'DESC'        )));        $this->set("dtls", $dtls);    }    function upload_img($filename, $type) {        if (file_exists(BLOG_IMAGE_PATH . $filename)) {            copy(BLOG_IMAGE_PATH . $filename, BLOG_LARGE_IMAGE_PATH . '/' . $filename);//            if ($type == "L") {//                copy(BLOG_IMAGE_PATH . $filename, BLOG_LARGE_IMAGE_PATH . '/' . $filename);//            } else {//                copy(BLOG_IMAGE_PATH . $filename, BLOG_MID_IMAGE_PATH . '/' . $filename);//            }            //unlink(BLOG_IMAGE_PATH . $filename);            if ($this->Upload->result) {                return $this->Upload->result;            } else {                return 0;            }        } else {            return 0;        }    }    function upload_images($filename) {        if (file_exists(BLOG_IMAGE_PATH . $filename)) {            list($w, $h, $type, $attr) = getimagesize(BLOG_IMAGE_PATH . $filename);            $scale2 = 530 / $w;            $scale3 = 530 / $w;            $scale4 = 900 / $w;            if ($w > 900) {                $this->resizeImage(BLOG_LARGE_IMAGE_PATH . '/' . $filename, BLOG_IMAGE_PATH . $filename, $w, $h, 0, 0, $scale4);            } else {                copy(BLOG_IMAGE_PATH . $filename, BLOG_LARGE_IMAGE_PATH . '/' . $filename);            }            if ($w > 530) {                $this->resizeImage(BLOG_MID_IMAGE_PATH . '/' . $filename, BLOG_IMAGE_PATH . $filename, $w, $h, 0, 0, $scale3);            } else {                copy(BLOG_IMAGE_PATH . $filename, BLOG_MID_IMAGE_PATH . '/' . $filename);            }            if ($w > 530) {                $this->resizeImage(BLOG_SMALL_IMAGE_PATH . '/' . $filename, BLOG_IMAGE_PATH . $filename, $w, $h, 0, 0, $scale2);            } else {                copy(BLOG_IMAGE_PATH . $filename, BLOG_SMALL_IMAGE_PATH . '/' . $filename);            }//pr($this->Upload);            if ($this->Upload->result) {                return $this->Upload->result;            } else {                return 0;            }        } else {            return 0;        }    }}